# Kubernetes Lab Project Context

## Purpose
- **Learning environment** for Kubernetes, observability, and cloud-native technologies
- **Self-contained setup** - everything runs locally with k3d
- **Experimentation friendly** - safe to try different approaches and configurations
- **Educational focus** - explain concepts and trade-offs, not just solutions

## Phased Learning Approach
- **Progressive complexity** - Each phase builds on previous knowledge
- **Tagged releases** - Use git tags with semantic versioning for each phase milestone
- **Automated deployment** - Tilt handles all deployment; learners focus on understanding concepts
- **Clear documentation** - Each phase has dedicated documentation and learning objectives
- **Exploration-based learning** - Exercises focus on understanding deployed services, not manual deployment

### Phase Structure
- **Phase 1 (v1.x)**: Foundation - Basic k3d, Prometheus, Grafana, Loki, Alloy
- **Phase 2 (v2.x)**: First Service - Single Go service with basic observability
- **Phase 3 (v3.x)**: Microservices - Multiple services with inter-service communication
- **Phase 4 (v4.x)**: Advanced Observability - APM, custom metrics, alerting

### Release Strategy
- **Git tags**: Use semantic versioning with descriptive suffixes (e.g., `v1.0.0-monitoring-foundation`)
- **GitHub releases**: Each tag gets a release with changelog and learning objectives
- **Documentation**: Each phase has dedicated docs in `phases/` directory
- **Scripts**: Phase-specific deployment scripts for easy setup

## Project Structure
- `k8s/apps/`: Application deployments (nginx-hello-world, etc.)
- `k8s/observability/`: Monitoring stack (Prometheus, Loki, Grafana, Alloy)
- `phases/`: Phase-specific documentation and learning guides
- `./kubectl-lab`: Wrapper script for kubectl commands against local k3d cluster
- `./start-lab.sh`: Script to start the k3d environment
- `./tilt-lab`: Wrapper script for Tilt with appropriate kubeconfig
- `Tiltfile`: Tilt configuration for automated deployment
- `scripts/manage-phases.sh`: Phase management and git tag utilities

## Technology Stack
- **Kubernetes**: k3d (Docker-based local cluster)
- **Monitoring**: Prometheus + Loki + Grafana + Alloy
- **Package Manager**: Helm charts
- **Local Development**: Tilt (automated deployment and development)
- **Learning Management**: Git tags for phase progression

## Automation vs Learning Philosophy
- **Tilt automation**: Handles all deployment complexity automatically
- **Learning focus**: Documentation explains concepts, not manual deployment steps
- **Phase exploration**: Learners can checkout git tags to see system state at each phase
- **Hands-on exercises**: Focus on understanding deployed services, not deployment mechanics
- **Progressive complexity**: Each phase builds on previous knowledge without deployment friction

## Key Patterns
- Use `./kubectl-lab` instead of direct kubectl for cluster operations
- Observability stack deployed in `monitoring` namespace
- Alloy uses Kubernetes API approach (not filesystem) for log collection
- Regular deployments preferred over DaemonSets when possible
- Services exposed via ingress with domain names (not port-forwarding)

## Service Access via Ingress
- **Domain Pattern**: `<service-name>.kubelab.lan:<port>` - All services use this domain format
- **k3d Port**: Services are accessed via port `8081` (configured in k3d setup)
- **Examples**:
  - Catalog Service: `catalog.kubelab.lan:8081`
  - Shopping Cart Service: `cart.kubelab.lan:8081`
  - Order Service: `orders.kubelab.lan:8081`
  - User Service: `users.kubelab.lan:8081`
- **etc/hosts Setup**: Add entries to `/etc/hosts` for local resolution:
  ```
  127.0.0.1 catalog.kubelab.lan
  127.0.0.1 cart.kubelab.lan
  127.0.0.1 orders.kubelab.lan
  127.0.0.1 users.kubelab.lan
  ```
- **Ingress Configuration**: Each service has its own ingress resource for domain-based routing
- **Real-world Simulation**: This mimics how services would be accessed in production environments

## Structured Logging Patterns
- **JSON logging format** - All applications should output structured JSON logs
- **Standard log fields** - Include timestamp, request details, response codes, performance metrics
- **ConfigMap approach** - Use ConfigMaps to configure application logging (e.g., nginx-configmap.yaml)
- **Loki annotations** - Add `loki.grafana.com/scrape: "true"` and `loki.grafana.com/log-format: "json"` to pod templates
- **Automatic collection** - Alloy automatically discovers and collects logs from all pods with proper labels
- **Health endpoints** - Include `/health` endpoints for monitoring with `access_log off` to reduce noise
- **Log levels** - Use appropriate log levels (info, warn, error) for different types of events

## ⚠️ SAFETY WARNINGS
- **ALWAYS use `./kubectl-lab`** - never use raw `kubectl` commands (protects against wrong context)
- **ALWAYS use `./tilt-lab`** -- which is preconfigured with appropriate kubeconfig
- **Production protection**: This setup is LOCAL ONLY - never apply these configs to production clusters
- **Context isolation**: Ensure k3d context is active before any cluster operations

## Common Commands
- `./start-lab.sh` - Start the k3d environment
- `./tilt-lab up` - Deploy all services automatically (main deployment command)
- `./kubectl-lab get pods -n monitoring` - Check observability stack
- `./kubectl-lab get nodes` - Verify k3d cluster is running
- `./kubectl-lab logs -n frontend -l app=nginx-hello-world` - View application logs
- `./kubectl-lab get ingress -A` - View all ingress resources and their domains
- `./scripts/manage-phases.sh list-phases` - List available learning phases
- `./scripts/manage-phases.sh checkout v1.0.0-monitoring-foundation` - Switch to a specific phase

## Configuration Files
- `*-values.yaml`: Helm chart configurations
- `*.yaml` in k8s/: Kubernetes manifests
- `*-configmap.yaml`: ConfigMaps for application configurations (logging, etc.)
- `*-ingress.yaml`: Ingress resources for domain-based routing
- Use specific namespaces for organization (monitoring, frontend, etc.)

## Architecture Decisions
- Alloy: Uses loki.source.kubernetes (API-based) instead of loki.source.file (filesystem-based)
- Security: Non-root containers when possible
- Networking: Services communicate via cluster DNS
- Logging: Structured JSON logs with comprehensive field coverage
- Monitoring: Prometheus for metrics, Loki for logs, Grafana for visualization
- Access: Ingress-based domain routing instead of port-forwarding

## Tiltfile Management
- ConfigMaps must be added to Tiltfile before their dependent deployments
- Use `helm_resource` for complex charts, `k8s_yaml` for simple manifests